---
/**
 * WizardStepsRenderer.astro
 * 
 * Renders an interactive stepped wizard flow from JSON data.
 * Supports multiple steps with choices, inline feedback after each selection,
 * blocker tracking, and outcome computation (READY/ALMOST/RESET).
 * 
 * Usage:
 * <WizardStepsRenderer 
 *   wizardSteps={entry.wizardSteps}
 *   wizardOutcomes={entry.wizardOutcomes}
 *   startStepId={entry.wizardStartStepId}
 *   wizardTitle="Getting Started Readiness Check"
 *   introDescription="Quick check to see if you're ready to start..."
 * />
 */

interface WizardStepChoice {
  label: string;
  feedbackText?: string; // Inline feedback message shown after selection (assessments only)
  routeType: "step" | "outcome";
  routeTarget?: string;
}

interface WizardStep {
  stepId: string;
  thoughtText: string;
  helperText?: string;
  choices: WizardStepChoice[];
}

interface WizardOutcome {
  key: string;
  title: string;
  body?: string;
  ctaLabel?: string;
  ctaHref?: string;
}

interface Props {
  wizardSteps: WizardStep[];
  wizardOutcomes: Record<string, WizardOutcome>;
  startStepId?: string;
  wizardTitle: string;
  introDescription?: string;
  startButtonLabel?: string;
}

const { 
  wizardSteps, 
  wizardOutcomes,
  startStepId,
  wizardTitle,
  introDescription = "This quick check helps you prepare and get practical guidance.",
  startButtonLabel = "Let's Check"
} = Astro.props;

const stepsDataJson = JSON.stringify({
  steps: wizardSteps,
  outcomes: wizardOutcomes,
  startStepId: startStepId || (wizardSteps[0]?.stepId || ''),
  wizardTitle,
  introDescription,
  startButtonLabel,
});
---

<style>
.options-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.75rem;
  margin: 1.5rem 0;
}

@media (min-width: 640px) {
  .options-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }
}

.feedback-bubble {
  margin-top: 1rem;
  padding: 1rem 1.25rem;
  border-radius: 1rem;
  background: var(--color-accent-subtle, #f0f9ff);
  border-left: 4px solid var(--color-accent, #0ea5e9);
  font-size: 0.95rem;
  line-height: 1.5;
}

.feedback-bubble--positive {
  background: var(--color-success-subtle, #f0fdf4);
  border-left-color: var(--color-success, #22c55e);
}

.feedback-bubble--caution {
  background: var(--color-warning-subtle, #fffbeb);
  border-left-color: var(--color-warning, #f59e0b);
}

.step-progress {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  font-size: 0.875rem;
  color: var(--color-text-muted, #6b7280);
}

.step-progress__dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--color-border, #d1d5db);
}

.step-progress__dot--active {
  background: var(--color-primary, #3b82f6);
}

.step-progress__dot--complete {
  background: var(--color-success, #22c55e);
}

.wizard-nav {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
}

.outcome-card {
  text-align: center;
  padding: 2rem;
}

.outcome-card__icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 1rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
}

.outcome-card__icon--ready {
  background: var(--color-success-subtle, #f0fdf4);
  color: var(--color-success, #22c55e);
}

.outcome-card__icon--almost {
  background: var(--color-warning-subtle, #fffbeb);
  color: var(--color-warning, #f59e0b);
}

.outcome-card__icon--reset {
  background: var(--color-error-subtle, #fef2f2);
  color: var(--color-error, #ef4444);
}

@media print {
  .wizard-steps-container .options-grid,
  .wizard-steps-container .kbm-button,
  .wizard-steps-container .wizard-nav {
    display: none !important;
  }
}
</style>

<div class="wizard-steps-container" id="wizard-steps-root" data-steps={stepsDataJson}></div>

<script>
  const container = document.getElementById('wizard-steps-root');
  if (container) {
    const stepsData = JSON.parse(container.dataset.steps || '{}');
    
    const { 
      steps, 
      outcomes,
      startStepId,
      wizardTitle, 
      introDescription,
      startButtonLabel
    } = stepsData;

    var currentView = 'intro';
    var currentStepId = startStepId;
    var stepHistory = [];
    var answers = {};
    var showingFeedback = false;
    var selectedChoiceIndex = null;

    var targetedOutcomeKey = null;
    
    function getStepById(stepId) {
      if (!steps || !stepId) return null;
      return steps.find(function(s) { return s.stepId === stepId; });
    }

    function getStepIndex(stepId) {
      if (!steps || !stepId) return -1;
      return steps.findIndex(function(s) { return s.stepId === stepId; });
    }

    function countBlockers() {
      var count = 0;
      Object.keys(answers).forEach(function(stepId) {
        var answer = answers[stepId];
        if (answer) {
          var normalized = answer.toLowerCase();
          if (normalized === "no" || normalized === "not sure") {
            count++;
          }
        }
      });
      return count;
    }

    function computeOutcomeKey() {
      if (targetedOutcomeKey && outcomes && outcomes[targetedOutcomeKey]) {
        return targetedOutcomeKey;
      }
      var blockers = countBlockers();
      if (blockers === 0) return "ready";
      if (blockers <= 2) return "almost";
      return "reset";
    }

    function getFeedback(choice) {
      // Determine feedback type based on choice label
      var normalized = (choice && choice.label) ? choice.label.toLowerCase().trim() : "";
      var feedbackType = "positive";
      if (normalized === "no" || normalized.indexOf("no") === 0 || normalized === "not sure") {
        feedbackType = "caution";
      }
      
      // Use feedbackText from choice data if provided (assessments)
      if (choice && choice.feedbackText && choice.feedbackText.trim()) {
        return { text: choice.feedbackText, type: feedbackType };
      }
      
      // Fallback to auto-generated feedback based on choice label
      if (choice && choice.label) {
        if (normalized === "yes" || normalized.indexOf("yes") === 0) {
          return { text: "Great choice!", type: "positive" };
        } else if (normalized === "no" || normalized.indexOf("no") === 0 || normalized === "not sure") {
          return { text: "We'll help you address this.", type: "caution" };
        }
      }
      return null;
    }

    function renderIntro() {
      return '<div class="kbm-card kbm-card--shadow">' +
        '<div class="kbm-card__header">' +
          '<h2 class="kbm-card__title" data-testid="text-wizard-title">' + wizardTitle + '</h2>' +
        '</div>' +
        '<div class="kbm-card__body">' +
          '<p class="kbm-lede" data-testid="text-intro-description">' + introDescription + '</p>' +
        '</div>' +
        '<div class="kbm-card__footer">' +
          '<button class="kbm-button kbm-button--primary" id="btn-start" data-testid="button-start">' + 
            startButtonLabel + 
          '</button>' +
        '</div>' +
      '</div>';
    }

    function renderStep() {
      var step = getStepById(currentStepId);
      if (!step) {
        return '<div class="kbm-card kbm-card--shadow">' +
          '<div class="kbm-card__body">' +
            '<p>Unable to load step. Please start over.</p>' +
            '<button class="kbm-button kbm-button--primary" id="btn-start-over" data-testid="button-start-over">Start Over</button>' +
          '</div>' +
        '</div>';
      }
      
      var stepIndex = getStepIndex(currentStepId);
      var totalSteps = steps.length;
      
      var progressDots = '';
      for (var i = 0; i < totalSteps; i++) {
        var dotClass = 'step-progress__dot';
        if (i < stepIndex) dotClass += ' step-progress__dot--complete';
        else if (i === stepIndex) dotClass += ' step-progress__dot--active';
        progressDots += '<span class="' + dotClass + '"></span>';
      }
      
      var choicesHtml = '';
      step.choices.forEach(function(choice, index) {
        var isSelected = selectedChoiceIndex === index;
        choicesHtml += '<button class="option-bubble' + (isSelected ? ' selected' : '') + '" ' +
          'data-choice-index="' + index + '" ' +
          'data-testid="button-choice-' + index + '">' +
          choice.label +
        '</button>';
      });
      
      var feedbackHtml = '';
      if (showingFeedback && selectedChoiceIndex !== null) {
        var selectedChoice = step.choices[selectedChoiceIndex];
        var feedback = getFeedback(selectedChoice);
        if (feedback) {
          feedbackHtml = '<div class="feedback-bubble feedback-bubble--' + feedback.type + '" data-testid="text-feedback">' +
            feedback.text +
          '</div>';
        }
      }
      
      var canContinue = showingFeedback && selectedChoiceIndex !== null;
      var isFirstStep = stepHistory.length === 0;
      
      return '<div class="kbm-card kbm-card--shadow">' +
        '<div class="kbm-card__header">' +
          '<div class="step-progress" data-testid="step-progress">' + progressDots + 
            '<span>Step ' + (stepIndex + 1) + ' of ' + totalSteps + '</span>' +
          '</div>' +
          '<div class="option-bubble" style="cursor: default; pointer-events: none; display: inline-block;" data-testid="text-thought-bubble">' +
            step.thoughtText +
          '</div>' +
          (step.helperText ? '<p class="kbm-card__subtitle" data-testid="text-helper">' + step.helperText + '</p>' : '') +
        '</div>' +
        '<div class="kbm-card__body">' +
          '<div class="options-grid">' + choicesHtml + '</div>' +
          feedbackHtml +
          '<div class="wizard-nav">' +
            (isFirstStep ? '' : '<button class="kbm-button kbm-button--secondary" id="btn-back" data-testid="button-back">Back</button>') +
            '<button class="kbm-button kbm-button--primary" id="btn-next" data-testid="button-next"' + 
              (canContinue ? '' : ' disabled') + '>Next</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function renderOutcome() {
      var outcomeType = computeOutcomeKey();
      
      var defaultOutcomes = {
        ready: {
          icon: "&#10003;",
          iconClass: "outcome-card__icon--ready",
          title: "You're Ready to Start!",
          body: "Great news — you have everything you need. Let's begin your knitting machine journey.",
          ctaLabel: "Get Started",
          ctaHref: "#"
        },
        almost: {
          icon: "&#9888;",
          iconClass: "outcome-card__icon--almost",
          title: "Almost There",
          body: "You're close! Review the items above and gather what you need before starting.",
          ctaLabel: "Review Checklist",
          ctaHref: "#"
        },
        reset: {
          icon: "&#10005;",
          iconClass: "outcome-card__icon--reset",
          title: "Let's Get Prepared First",
          body: "It looks like you need a few things before you begin. Take your time to gather the essentials.",
          ctaLabel: "Preparation Guide",
          ctaHref: "#"
        }
      };
      
      var providedOutcome = outcomes && outcomes[outcomeType];
      var iconMap = { ready: "&#10003;", almost: "&#9888;", reset: "&#10005;" };
      var iconClassMap = { ready: "outcome-card__icon--ready", almost: "outcome-card__icon--almost", reset: "outcome-card__icon--reset" };
      
      var config = providedOutcome ? {
        icon: iconMap[outcomeType],
        iconClass: iconClassMap[outcomeType],
        title: providedOutcome.title || defaultOutcomes[outcomeType].title,
        body: providedOutcome.body || defaultOutcomes[outcomeType].body,
        ctaLabel: providedOutcome.ctaLabel || defaultOutcomes[outcomeType].ctaLabel,
        ctaHref: providedOutcome.ctaHref || defaultOutcomes[outcomeType].ctaHref
      } : defaultOutcomes[outcomeType];
      
      var blockers = countBlockers();
      
      var summaryHtml = '';
      if (blockers > 0) {
        summaryHtml = '<div style="margin-bottom: 1.5rem; text-align: left;">' +
          '<h3 class="kbm-wizard__result-heading">Items to Address:</h3>' +
          '<ul class="kbm-wizard__result-list">';
        
        Object.keys(answers).forEach(function(stepId) {
          var answer = answers[stepId];
          if (answer) {
            var normalized = answer.toLowerCase();
            if (normalized === "no" || normalized === "not sure") {
              var step = getStepById(stepId);
              if (step) {
                summaryHtml += '<li>' + step.thoughtText + ' — <em>' + answer + '</em></li>';
              }
            }
          }
        });
        
        summaryHtml += '</ul></div>';
      }
      
      return '<div class="kbm-card kbm-card--shadow">' +
        '<div class="kbm-card__body outcome-card">' +
          '<div class="outcome-card__icon ' + config.iconClass + '">' + config.icon + '</div>' +
          '<h2 class="kbm-card__title" data-testid="text-outcome-title">' + config.title + '</h2>' +
          '<p data-testid="text-outcome-body">' + config.body + '</p>' +
          summaryHtml +
        '</div>' +
        '<div class="kbm-card__footer" style="justify-content: center;">' +
          '<button class="kbm-button kbm-button--primary" id="btn-start-over" data-testid="button-start-over">Start Over</button>' +
          (config.ctaHref !== '#' ? '<a href="' + config.ctaHref + '" class="kbm-button kbm-button--secondary" data-testid="button-cta">' + config.ctaLabel + '</a>' : '') +
        '</div>' +
      '</div>';
    }

    function render() {
      var html = '';
      if (currentView === 'intro') {
        html = renderIntro();
      } else if (currentView === 'step') {
        html = renderStep();
      } else if (currentView === 'outcome') {
        html = renderOutcome();
      }

      container.innerHTML = html;
      attachEventListeners();
      
      var actionBar = document.getElementById('action-bar');
      var printBtn = document.getElementById('print-btn');
      
      if (currentView === 'outcome') {
        if (actionBar) actionBar.style.display = 'flex';
        if (printBtn) printBtn.style.display = 'block';
      } else {
        if (actionBar) actionBar.style.display = 'none';
      }
    }

    function attachEventListeners() {
      var btnStart = document.getElementById('btn-start');
      var btnBack = document.getElementById('btn-back');
      var btnNext = document.getElementById('btn-next');
      var btnStartOver = document.getElementById('btn-start-over');
      var choiceButtons = container.querySelectorAll('[data-choice-index]');

      if (btnStart) {
        btnStart.addEventListener('click', function() {
          currentView = 'step';
          currentStepId = startStepId;
          render();
        });
      }

      if (btnBack) {
        btnBack.addEventListener('click', function() {
          if (stepHistory.length > 0) {
            var prevStepId = stepHistory.pop();
            delete answers[currentStepId];
            currentStepId = prevStepId;
            selectedChoiceIndex = null;
            showingFeedback = false;
            render();
          }
        });
      }

      if (btnNext) {
        btnNext.addEventListener('click', function() {
          if (selectedChoiceIndex === null) return;
          
          var step = getStepById(currentStepId);
          if (!step) return;
          
          var selectedChoice = step.choices[selectedChoiceIndex];
          
          answers[currentStepId] = selectedChoice.label;
          
          if (selectedChoice.routeType === 'outcome') {
            targetedOutcomeKey = selectedChoice.routeTarget || null;
            currentView = 'outcome';
          } else {
            stepHistory.push(currentStepId);
            currentStepId = selectedChoice.routeTarget;
          }
          
          selectedChoiceIndex = null;
          showingFeedback = false;
          render();
        });
      }

      if (btnStartOver) {
        btnStartOver.addEventListener('click', function() {
          currentView = 'intro';
          currentStepId = startStepId;
          stepHistory = [];
          answers = {};
          selectedChoiceIndex = null;
          showingFeedback = false;
          targetedOutcomeKey = null;
          render();
        });
      }

      choiceButtons.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          var target = e.currentTarget;
          if (target) {
            var idx = parseInt(target.getAttribute('data-choice-index'), 10);
            selectedChoiceIndex = idx;
            showingFeedback = true;
            render();
          }
        });
      });
    }

    var externalStartOver = document.getElementById('start-over-btn');
    if (externalStartOver) {
      externalStartOver.addEventListener('click', function() {
        currentView = 'intro';
        currentStepId = startStepId;
        stepHistory = [];
        answers = {};
        selectedChoiceIndex = null;
        showingFeedback = false;
        targetedOutcomeKey = null;
        render();
      });
    }

    var printBtn = document.getElementById('print-btn');
    if (printBtn) {
      printBtn.addEventListener('click', function() {
        window.print();
      });
    }

    render();
  }
</script>

---
import Layout from "../../layouts/layout.astro";
import GlossaryEntry from "../../components/GlossaryEntry.astro";
import glossary from "../../data/glossary.json";
import { slugify } from "../../lib/slugify";

function cleanTerm(v: any) {
  return (v ?? "").toString().replace(/<[^>]*>/g, "").trim();
}

const { slug } = Astro.params;
const normalizedSlug = (slug ?? "").toString().trim().toLowerCase();

export async function getStaticPaths() {
  function cleanTerm(v: any) {
    return (v ?? "").toString().replace(/<[^>]*>/g, "").trim();
  }
  return glossary
    .filter((t: any) => cleanTerm(t.english).length > 0)
    .map((t: any) => ({
      params: { slug: slugify(cleanTerm(t.english)) },
    }));
}

const entry = glossary.find(
  (t: any) => slugify(cleanTerm(t.english)) === normalizedSlug
);

if (!entry) {
  return Astro.redirect("/glossary");
}

const relatedTermsData: Array<{ slug: string; term: string }> = [];
---

<Layout title={`${(entry as any).english ?? "Term"} | Glossary`}>
  <style>
    main.glossaryEntry {
      margin-top: 0;
      padding-top: 0;
    }
  </style>
  <main class="glossaryEntry" data-glossary-entry>
    <GlossaryEntry entry={entry} relatedTermsData={relatedTermsData} />
  </main>

  <script>
    const userIsMember = false; // Replace with real membership logic
    if (userIsMember) {
      document.querySelectorAll('[data-member="true"]').forEach(el => (el as HTMLElement).style.display = 'block');
      document.querySelectorAll('[data-member="false"]').forEach(el => (el as HTMLElement).style.display = 'none');
    }
  </script>
</Layout>

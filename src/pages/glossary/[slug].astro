---
import Layout from "../../layouts/Layout.astro";
import GlossaryEntry from "../../components/GlossaryEntry.astro";
import glossary from "../../data/glossary.json";
import { slugify } from "../../lib/slugify";
import PageHead from "../../components/PageHead.astro";
function cleanTerm(v: any) {
  return (v ?? "").toString().replace(/<[^>]*>/g, "").trim();
}

const { slug } = Astro.params;
const normalizedSlug = (slug ?? "").toString().trim().toLowerCase();

export async function getStaticPaths() {
  function cleanTerm(v: any) {
    return (v ?? "").toString().replace(/<[^>]*>/g, "").trim();
  }
  return glossary
    .filter((t: any) => cleanTerm(t.english).length > 0)
    .map((t: any) => ({
      params: { slug: slugify(cleanTerm(t.english)) },
    }));
}

const entry = glossary.find(
  (t: any) => slugify(cleanTerm(t.english)) === normalizedSlug
);

if (!entry) {
  return Astro.redirect("/glossary");
}

const relatedTermsData: Array<{ slug: string; term: string }> = [];
const termLabel = cleanTerm((entry as any).english);
---

<Layout title={`${termLabel} | Glossary`} description={`Glossary definition: ${termLabel}`}>
  <div class="page-wrap">
    <PageHead
      title={termLabel}
      breadcrumb={`Home / Glossary / ${termLabel}`}
    />
    <article class="glossary-entry" data-glossary-entry>
      <GlossaryEntry entry={entry} relatedTermsData={relatedTermsData} />
    </article>
  </div>

  <style>
    .page-wrap .kbm-breadcrumb {
      font-size: var(--text-base);
      margin-bottom: 1rem;
      color: #6b7280;
    }
    /* Single H1: PageHead is the page title; hide duplicate from GlossaryEntry */
    .page-wrap .glossary-entry h1 {
      display: none;
    }
  </style>

  <script>
    const userIsMember = false; // Replace with real membership logic
    if (userIsMember) {
      document.querySelectorAll('[data-member="true"]').forEach(el => (el as HTMLElement).style.display = 'block');
      document.querySelectorAll('[data-member="false"]').forEach(el => (el as HTMLElement).style.display = 'none');
    }
  </script>
</Layout>
